import t from"decompress-response";import e from"follow-redirects";import o from"http";import r from"https";import n from"progress-stream";import s from"querystring";import{Readable as c}from"stream";import a from"url";import*as p from"tunnel-agent";function i(t){return Object.keys(t||{}).reduce(((e,o)=>(e[o.toLowerCase()]=t[o],e)),{})}function u(t){return t.replace(/^\.*/,".").toLowerCase()}function d(t){const e=t.trim().toLowerCase(),o=e.split(":",2);return{hostname:u(o[0]),port:o[1],hasPort:e.indexOf(":")>-1}}function h(t){const e=process.env.NO_PROXY||process.env.no_proxy||"";return"*"===e||""!==e&&function(t,e){const o=t.port||("https:"===t.protocol?"443":"80"),r=u(t.hostname);return e.split(",").map(d).some((t=>{const e=r.indexOf(t.hostname),n=e>-1&&e===r.length-t.hostname.length;return t.hasPort?o===t.port&&n:n}))}(t,e)?null:"http:"===t.protocol?process.env.HTTP_PROXY||process.env.http_proxy||null:"https:"===t.protocol&&(process.env.HTTPS_PROXY||process.env.https_proxy||process.env.HTTP_PROXY||process.env.http_proxy)||null}const l=["protocol","slashes","auth","host","port","hostname","hash","search","query","pathname","path","href"],m=["accept","accept-charset","accept-encoding","accept-language","accept-ranges","cache-control","content-encoding","content-language","content-location","content-md5","content-range","content-type","connection","date","expect","max-forwards","pragma","referer","te","user-agent","via"],f=["proxy-authorization"];function y(t={},e){const o=Object.assign({},t),r=m.concat(o.proxyHeaderWhiteList||[]).map((t=>t.toLowerCase())),n=f.concat(o.proxyHeaderExclusiveList||[]).map((t=>t.toLowerCase())),s=(c=o.headers,a=r,Object.keys(c).filter((t=>-1!==a.indexOf(t.toLowerCase()))).reduce(((t,e)=>(t[e]=c[e],t)),{}));var c,a;s.host=function(t){const e=t.port,o=t.protocol;let r=`${t.hostname}:`;return r+=e||("https:"===o?"443":"80"),r}(o),o.headers=Object.keys(o.headers||{}).reduce(((t,e)=>(-1===n.indexOf(e.toLowerCase())&&(t[e]=o.headers[e]),t)),{});const i=function(t,e){const o=function(t){return l.reduce(((e,o)=>(e[o]=t[o],e)),{})}(t),r=function(t,e){const o="https:"===t.protocol?"https":"http",r="https:"===e.protocol?"Https":"Http";return`${o}Over${r}`}(o,e);return p[r]}(o,e),u=function(t,e,o){return{proxy:{host:e.hostname,port:+e.port,proxyAuth:e.auth,headers:o},headers:t.headers,ca:t.ca,cert:t.cert,key:t.key,passphrase:t.passphrase,pfx:t.pfx,ciphers:t.ciphers,rejectUnauthorized:t.rejectUnauthorized,secureOptions:t.secureOptions,secureProtocol:t.secureProtocol}}(o,e,s);return o.agent=i(u),o}const b=t=>null!==t&&"object"==typeof t&&"function"==typeof t.pipe,g="node";class x extends Error{request;code;constructor(t,e){super(t.message),this.request=e,this.code=t.code}}const w=(t,e,o,r)=>({body:r,url:e,method:o,headers:t.headers,statusCode:t.statusCode,statusMessage:t.statusMessage}),O=(p,u)=>{const{options:d}=p,l=Object.assign({},a.parse(d.url));if("function"==typeof fetch&&d.fetch){const t=new AbortController,e=p.applyMiddleware("finalizeOptions",{...l,method:d.method,headers:{..."object"==typeof d.fetch&&d.fetch.headers?i(d.fetch.headers):{},...i(d.headers)},maxRedirects:d.maxRedirects}),o={credentials:d.withCredentials?"include":"omit",..."object"==typeof d.fetch?d.fetch:{},method:e.method,headers:e.headers,body:d.body,signal:t.signal},r=p.applyMiddleware("interceptRequest",void 0,{adapter:g,context:p});if(r){const t=setTimeout(u,0,null,r);return{abort:()=>clearTimeout(t)}}const n=fetch(d.url,o);return p.applyMiddleware("onRequest",{options:d,adapter:g,request:n,context:p}),n.then((async t=>{const e=d.rawBody?t.body:await t.text(),o={};t.headers.forEach(((t,e)=>{o[e]=t})),u(null,{body:e,url:t.url,method:d.method,headers:o,statusCode:t.status,statusMessage:t.statusText})})).catch((t=>{"AbortError"!=t.name&&u(t)})),{abort:()=>t.abort()}}const m=b(d.body)?"stream":typeof d.body;if("undefined"!==m&&"stream"!==m&&"string"!==m&&!Buffer.isBuffer(d.body))throw new Error(`Request body must be a string, buffer or stream, got ${m}`);const f={};d.bodySize?f["content-length"]=d.bodySize:d.body&&"stream"!==m&&(f["content-length"]=Buffer.byteLength(d.body));let O=!1;const T=(t,e)=>!O&&u(t,e);p.channels.abort.subscribe((()=>{O=!0}));let v=Object.assign({},l,{method:d.method,headers:Object.assign({},i(d.headers),f),maxRedirects:d.maxRedirects});const R=function(t){let e;e=t.hasOwnProperty("proxy")?t.proxy:h(a.parse(t.url));return"string"==typeof e?a.parse(e):e}(d),j=R&&function(t){return typeof t.tunnel<"u"?!!t.tunnel:"https:"===a.parse(t.url).protocol}(d),q=p.applyMiddleware("interceptRequest",void 0,{adapter:g,context:p});if(q){const t=setImmediate(T,null,q);return{abort:()=>clearImmediate(t)}}if(0!==d.maxRedirects&&(v.maxRedirects=d.maxRedirects||5),R&&j?v=y(v,R):R&&!j&&(v=function(t,e,o){const r=t.headers||{},n=Object.assign({},t,{headers:r});return r.host=r.host||function(t){const e=t.port||("https:"===t.protocol?"443":"80");return`${t.hostname}:${e}`}(e),n.protocol=o.protocol||n.protocol,n.hostname=o.host.replace(/:\d+/,""),n.port=o.port,n.host=function(t){let e=t.host;return t.port&&("80"===t.port&&"http:"===t.protocol||"443"===t.port&&"https:"===t.protocol)&&(e=t.hostname),e}(Object.assign({},e,o)),n.href=`${n.protocol}//${n.host}${n.path}`,n.path=a.format(e),n}(v,l,R)),!j&&R&&R.auth&&!v.headers["proxy-authorization"]){const[t,e]=R.auth.username?[R.auth.username,R.auth.password]:R.auth.split(":").map((t=>s.unescape(t))),o=Buffer.from(`${t}:${e}`,"utf8").toString("base64");v.headers["proxy-authorization"]=`Basic ${o}`}const C=function(t,n,s){const c="https:"===t.protocol,a=0===t.maxRedirects?{http:o,https:r}:{http:e.http,https:e.https};if(!n||s)return c?a.https:a.http;let p=443===n.port;return n.protocol&&(p=/^https:?/.test(n.protocol)),p?a.https:a.http}(v,R,j);"function"==typeof d.debug&&R&&d.debug("Proxying using %s",v.agent?"tunnel agent":`${v.host}:${v.port}`);const $="HEAD"!==v.method;let E;$&&!v.headers["accept-encoding"]&&!1!==d.compress&&(v.headers["accept-encoding"]=typeof Bun<"u"?"gzip, deflate":"br, gzip, deflate");const L=p.applyMiddleware("finalizeOptions",v),P=C.request(L,(e=>{const o=$?t(e):e;E=o;const r=p.applyMiddleware("onHeaders",o,{headers:e.headers,adapter:g,context:p}),n="responseUrl"in e?e.responseUrl:d.url;d.stream?T(null,w(o,n,v.method,r)):function(t,e){const o=[];t.on("data",(function(t){o.push(t)})),t.once("end",(function(){e&&e(null,Buffer.concat(o)),e=null})),t.once("error",(function(t){e&&e(t),e=null}))}(r,((t,e)=>{if(t)return T(t);const r=d.rawBody?e:e.toString(),s=w(o,n,v.method,r);return T(null,s)}))}));function z(t){E&&E.destroy(t),P.destroy(t)}P.once("socket",(t=>{t.once("error",z),P.once("response",(e=>{e.once("end",(()=>{t.removeListener("error",z)}))}))})),P.once("error",(t=>{E||T(new x(t,P))})),d.timeout&&function(t,e){if(t.timeoutTimer)return t;const o=isNaN(e)?e:{socket:e,connect:e},r=t.getHeader("host"),n=r?" to "+r:"";function s(){t.timeoutTimer&&(clearTimeout(t.timeoutTimer),t.timeoutTimer=null)}function c(e){if(s(),void 0!==o.socket){const r=()=>{const t=new Error("Socket timed out on request"+n);t.code="ESOCKETTIMEDOUT",e.destroy(t)};e.setTimeout(o.socket,r),t.once("response",(t=>{t.once("end",(()=>{e.removeListener("timeout",r)}))}))}}void 0!==o.connect&&(t.timeoutTimer=setTimeout((function(){const e=new Error("Connection timed out on request"+n);e.code="ETIMEDOUT",t.destroy(e)}),o.connect)),t.on("socket",(function(t){t.connecting?t.once("connect",(()=>c(t))):c(t)})),t.on("error",s)}(P,d.timeout);const{bodyStream:M,progress:k}=function(t){if(!t.body)return{};const e=b(t.body),o=t.bodySize||(e?null:Buffer.byteLength(t.body));if(!o)return e?{bodyStream:t.body}:{};const r=n({time:16,length:o});return{bodyStream:(e?t.body:c.from(t.body)).pipe(r),progress:r}}(d);return p.applyMiddleware("onRequest",{options:d,adapter:g,request:P,context:p,progress:k}),M?M.pipe(P):P.end(d.body),{abort:()=>P.abort()}};export{x as N,g as a,O as h};//# sourceMappingURL=node-request.js.map
